#!/bin/bash

echo "Build of CZERTAINLY CORE"

echo "Cleaning containers"
docker rm czertainly_core_container
docker rmi prebuild

echo "Removing the tmp directory"
rm -r /tmp/docker
rm -r /tmp/target

echo "PreBuild build"
docker build -f $DOCKERFILE_PATH-pre -t prebuild .
docker run --build-arg SERVER_USERNAME=$SERVER_USERNAME --build-arg SERVER_PASSWORD=$SERVER_PASSWORD -v /var/run/docker.sock:/var/run/docker.sock --name czertainly_core_container -it prebuild mvn -f /home/app/pom.xml clean package

echo "Starting czertainly_core_container"
docker start -d --restart=always czertainly_core_container

echo "Copy jar back to Tmp"
docker cp czertainly_core_container:/home/app/target /tmp
docker cp czertainly_core_container:/home/app/docker /tmp

echo "Build main image"
docker build -f $DOCKERFILE_PATH -t $IMAGE_NAME .
